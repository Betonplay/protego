language: python
dist: trusty
branches:
  only:
  - master
  - "/^\\d\\.\\d+$/"
  - "/^\\d\\.\\d+\\.\\d+(rc\\d+|\\.dev\\d+)?$/"
matrix:
  include:
  - python: 2.7
    env: TOXENV=py27
  - python: 3.5
    env: TOXENV=py35
  - python: 3.6
    env: TOXENV=py36
  - python: 3.7
    env: TOXENV=py37
    dist: xenial
    sudo: true
  - python: 2.7
    env: TOXENV=pypy
  - python: 2.7
    env: TOXENV=pypy3
install:
- |
  if [ "$TOXENV" = "pypy" ]; then
    export PYPY_VERSION="pypy-6.0.0-linux_x86_64-portable"
    wget "https://bitbucket.org/squeaky/portable-pypy/downloads/${PYPY_VERSION}.tar.bz2"
    tar -jxf ${PYPY_VERSION}.tar.bz2
    virtualenv --python="$PYPY_VERSION/bin/pypy" "$HOME/virtualenvs/$PYPY_VERSION"
    source "$HOME/virtualenvs/$PYPY_VERSION/bin/activate"
  fi
  if [ "$TOXENV" = "pypy3" ]; then
    export PYPY_VERSION="pypy3.5-5.9-beta-linux_x86_64-portable"
    wget "https://bitbucket.org/squeaky/portable-pypy/downloads/${PYPY_VERSION}.tar.bz2"
    tar -jxf ${PYPY_VERSION}.tar.bz2
    virtualenv --python="$PYPY_VERSION/bin/pypy3" "$HOME/virtualenvs/$PYPY_VERSION"
    source "$HOME/virtualenvs/$PYPY_VERSION/bin/activate"
  fi
- pip install -U tox
script: tox
deploy:
  provider: pypi
  user: anubhavp
  password:
    secure: FSm+2GEwzgZH56FbNml782qGO7zznd/4MsaDe42lsxJ88TP+tdyXmiexJLnRrXoq+rYn9jyvj1s/2DbnB089HUV86dBL2uXNaLBZbeA1zU+eP2KTRooWa9VnUvOgoReyjx+jnRnIUzxXQbkQv8cBVvGoql69nWA8paBeEhYP6JcRL3tScOOO/i/evPCaImgmgEvI5BGDa3j1tSRub87uVmtLzbRFobyVl/SK8c6JB1/n3QRBAG0Ecqyevvh1v9kBTSTPwyyZUThwzP+0bA+94x728feM0Zms3XTARsM25r2qV+1YEnwx2L8AIEqezDCmJkFDBeoHPLb61LSmO50zpK1YqMkQXf4ZJDutWzBD62r37fQ8hVByTHPO6bxYZ6FbgRnYtB738NbbbZcNThLb466aTS6qpcVznGVSyOb8D0Yv3DXqwGzXgHZzyNQd7u9BpNl36cLORayQ3BL1DpiM8OBO2UuG9+PZeSdWW1V5m6+ChTvs7JeDb8kbLIBUZlG/IAxh4SqIwmTAYEDHIFLsKh3lu6K7lG7Mb2q6u5G23VlSpaflsK9pZ+ocRS35L7Kfm4w8k9uwk/pEeEo5M/JXfIvRgr7dUvMYxjkDR/ugdsGQgsarubVZtPGWsjngE7JdWPIlRHRYdl0qtqMBntx4w6QtbinpLrq5WgufUo0uG9E=
  on:
    tags: true
    repo: scrapy/protego
    condition: "$TOXENV == py27 && $TRAVIS_TAG =~ ^[0-9]+[.][0-9]+[.][0-9]+(rc[0-9]+|[.]dev[0-9]+)?$"
